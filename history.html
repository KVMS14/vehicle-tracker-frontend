<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Rutas</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
  
    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }
  
    #topbar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 8px 12px;
      border-radius: 10px;
      z-index: 1000;
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 14px;
    }
  
    #topbar input {
      border-radius: 6px;
      border: none;
      padding: 4px;
    }

    #routesList {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 10px 12px;
      border-radius: 10px;
      z-index: 1000;
      max-height: 40vh;
      overflow-y: auto;
      font-size: 14px;
      min-width: 260px;
    }
    
    .route-item {
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

  </style>

</head>
<body>

  <div id="topbar">
    ðŸ“… <input type="date" id="datePicker" />
    <span id="info"></span>
  </div>

  <div id="routesList"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const API_BASE = "https://vehicle-backend-ocks.onrender.com";

    const map = L.map("map", {
      zoomControl: true,
      attributionControl: false,
      tap: true,
      dragging: true,
      touchZoom: true,
      doubleClickZoom: true,
      scrollWheelZoom: true,
      boxZoom: false
    }).setView([-1.64, -78.68], 16);

    setTimeout(() => {
      map.invalidateSize();
    }, 300);

    window.addEventListener("orientationchange", () => {
      setTimeout(() => {
        map.invalidateSize();
      }, 300);
    });

    window.addEventListener("resize", () => {
      map.invalidateSize();
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap",
      maxZoom: 20,     // ðŸ”¥ MÃS ZOOM
      minZoom: 3
    }).addTo(map);

    const colors = ["red", "blue", "green", "purple", "orange", "brown"];

    const startIcon = L.icon({
      iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });

    const endIcon = L.icon({
      iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });

    const datePicker = document.getElementById("datePicker");
    const info = document.getElementById("info");
    const routesList = document.getElementById("routesList");

    const drawnRoutes = {};

    datePicker.valueAsDate = new Date();
    datePicker.addEventListener("change", loadRoutes);

    async function loadRoutes() {
      clearAll();
      routesList.innerHTML = "";
      info.innerText = "Cargando rutas...";

      const date = datePicker.value;

      const res = await fetch(`${API_BASE}/routes/by-date/${date}`);
      const routes = await res.json();

      if (!routes.length) {
        info.innerText = "No hay rutas este dÃ­a";
        return;
      }

      routes.forEach((route, index) => {
        const start = new Date(route.startTime);
        const end = route.endTime ? new Date(route.endTime) : null;

        const label = `Ruta ${index + 1} â€” ${start.toLocaleTimeString()} ${end ? "â†’ " + end.toLocaleTimeString() : ""}`;

        const div = document.createElement("div");
        div.className = "route-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";

        checkbox.addEventListener("change", () => {
          checkbox.checked ? drawRoute(route, index) : removeRoute(route._id);
        });

        div.appendChild(checkbox);
        div.append(" " + label);
        routesList.appendChild(div);
      });

      info.innerText = `${routes.length} ruta(s) disponibles`;
    }

    function drawRoute(route, index) {
      const latlngs = route.points.map(p => [p.lat, p.lon]);
      const color = colors[index % colors.length];
    
      const polyline = L.polyline(latlngs, {
        color,
        weight: 4
      }).addTo(map);

      const startIcon = L.icon({
        iconUrl: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
        iconSize: [40, 40],
        iconAnchor: [20, 40]
      });
      
      const endIcon = L.icon({
        iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
        iconSize: [40, 40],
        iconAnchor: [20, 40]
      });

      const startPoint = latlngs[0];
      const endPoint = latlngs[latlngs.length - 1];

      const startMarker = L.marker(startPoint, { icon: startIcon })
        .addTo(map)
        .bindPopup("ðŸŸ¢ Inicio de ruta");
    
      const endMarker = L.marker(endPoint, { icon: endIcon })
        .addTo(map)
        .bindPopup("ðŸ”´ Fin de ruta");
    
      // ðŸ‘‰ POPUP DE INFORMACIÃ“N DE LA RUTA
      const popupContent = `
        <strong>Ruta ${index + 1}</strong><br/>
        <b>Inicio:</b> ${startPoint[0].toFixed(6)}, ${startPoint[1].toFixed(6)}<br/>
        <b>Fin:</b> ${endPoint[0].toFixed(6)}, ${endPoint[1].toFixed(6)}<br/>
        <b>Coordenadas registradas:</b> ${route.points.length}
      `;
    
      polyline.on("click", e => {
        L.popup()
          .setLatLng(e.latlng)
          .setContent(popupContent)
          .openOn(map);
      });
    
      drawnRoutes[route._id] = {
        polyline,
        startMarker,
        endMarker
      };
    
      map.fitBounds(polyline.getBounds());
    }


    function removeRoute(id) {
      const r = drawnRoutes[id];
      if (!r) return;
      map.removeLayer(r.polyline);
      map.removeLayer(r.startMarker);
      map.removeLayer(r.endMarker);
      delete drawnRoutes[id];
    }

    function clearAll() {
      Object.keys(drawnRoutes).forEach(removeRoute);
    }

    loadRoutes();
  </script>

</body>
</html>


