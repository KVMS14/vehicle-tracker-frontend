<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Rutas</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100vw;
    }

    #topbar {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 10px;
      border-radius: 6px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #routesList {
      position: absolute;
      top: 60px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 14px;
      min-width: 260px;
    }

    .route-item {
      margin-bottom: 6px;
    }
  </style>
</head>
<body>

  <div id="topbar">
    ðŸ“… <input type="date" id="datePicker" />
    <span id="info"></span>
  </div>

  <div id="routesList"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const API_BASE = "https://vehicle-backend-ocks.onrender.com";

    const map = L.map("map").setView([-1.64, -78.68], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap"
    }).addTo(map);

    const colors = ["red", "blue", "green", "purple", "orange", "brown"];

    const startIcon = L.icon({
      iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });

    const endIcon = L.icon({
      iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });

    const datePicker = document.getElementById("datePicker");
    const info = document.getElementById("info");
    const routesList = document.getElementById("routesList");

    const drawnRoutes = {};

    datePicker.valueAsDate = new Date();
    datePicker.addEventListener("change", loadRoutes);

    async function loadRoutes() {
      clearAll();
      routesList.innerHTML = "";
      info.innerText = "Cargando rutas...";

      const date = datePicker.value;

      const res = await fetch(`${API_BASE}/routes/by-date/${date}`);
      const routes = await res.json();

      if (!routes.length) {
        info.innerText = "No hay rutas este dÃ­a";
        return;
      }

      routes.forEach((route, index) => {
        const start = new Date(route.startTime);
        const end = route.endTime ? new Date(route.endTime) : null;

        const label = `Ruta ${index + 1} â€” ${start.toLocaleTimeString()} ${end ? "â†’ " + end.toLocaleTimeString() : ""}`;

        const div = document.createElement("div");
        div.className = "route-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";

        checkbox.addEventListener("change", () => {
          checkbox.checked ? drawRoute(route, index) : removeRoute(route._id);
        });

        div.appendChild(checkbox);
        div.append(" " + label);
        routesList.appendChild(div);
      });

      info.innerText = `${routes.length} ruta(s) disponibles`;
    }

    function drawRoute(route, index) {
      const latlngs = route.points.map(p => [p.lat, p.lon]);
      const color = colors[index % colors.length];

      const polyline = L.polyline(latlngs, { color, weight: 4 }).addTo(map);

      const startMarker = L.marker(latlngs[0], { icon: startIcon })
        .addTo(map)
        .bindPopup("ðŸŸ¢ Inicio de ruta");

      const endMarker = L.marker(latlngs[latlngs.length - 1], { icon: endIcon })
        .addTo(map)
        .bindPopup("ðŸ”´ Fin de ruta");

      drawnRoutes[route._id] = { polyline, startMarker, endMarker };
      map.fitBounds(polyline.getBounds());
    }

    function removeRoute(id) {
      const r = drawnRoutes[id];
      if (!r) return;
      map.removeLayer(r.polyline);
      map.removeLayer(r.startMarker);
      map.removeLayer(r.endMarker);
      delete drawnRoutes[id];
    }

    function clearAll() {
      Object.keys(drawnRoutes).forEach(removeRoute);
    }

    loadRoutes();
  </script>

</body>
</html>


