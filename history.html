<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Rutas</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body, html {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #topbar {
      padding: 10px;
      background: #222;
      color: white;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    #routesList {
      padding: 10px;
      background: #f4f4f4;
      max-height: 150px;
      overflow-y: auto;
      font-size: 14px;
    }

    .route-item {
      margin-bottom: 6px;
    }

    #map {
      height: calc(100% - 220px);
    }
  </style>
</head>
<body>

  <div id="topbar">
    ðŸ“… <input type="date" id="datePicker" />
    <span id="info"></span>
  </div>

  <div id="routesList"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const API_BASE = "https://vehicle-backend-ocks.onrender.com";

    const map = L.map("map").setView([-1.64, -78.68], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap"
    }).addTo(map);

    const colors = ["red", "blue", "green", "purple", "orange", "brown"];

    const datePicker = document.getElementById("datePicker");
    const info = document.getElementById("info");
    const routesList = document.getElementById("routesList");

    const drawnRoutes = {}; // routeId -> layers

    datePicker.valueAsDate = new Date();
    datePicker.addEventListener("change", loadRoutes);

    async function loadRoutes() {
      clearAll();
      routesList.innerHTML = "";
      info.innerText = "Cargando rutas...";

      const date = datePicker.value;

      try {
        const res = await fetch(`${API_BASE}/routes/by-date/${date}`);
        const routes = await res.json();

        if (!routes.length) {
          info.innerText = "No hay rutas este dÃ­a";
          return;
        }

        routes.forEach((route, index) => {
          const start = new Date(route.startTime);
          const end = route.endTime ? new Date(route.endTime) : null;

          const label = `
            Ruta ${index + 1} â€” 
            Inicio ${start.toLocaleTimeString()} 
            ${end ? "â€” Fin " + end.toLocaleTimeString() : ""}
          `;

          const div = document.createElement("div");
          div.className = "route-item";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";

          checkbox.addEventListener("change", () => {
            if (checkbox.checked) {
              drawRoute(route, index);
            } else {
              removeRoute(route._id);
            }
          });

          div.appendChild(checkbox);
          div.append(" " + label);
          routesList.appendChild(div);
        });

        info.innerText = `${routes.length} ruta(s) disponibles`;

      } catch (err) {
        console.error(err);
        info.innerText = "Error cargando rutas";
      }
    }

    function drawRoute(route, index) {
      if (!route.points || route.points.length < 2) return;

      const color = colors[index % colors.length];
      const latlngs = route.points.map(p => [p.lat, p.lon]);

      const polyline = L.polyline(latlngs, {
        color,
        weight: 4
      }).addTo(map);

      const startMarker = L.marker(latlngs[0], {
        title: "Inicio"
      }).addTo(map);

      const endMarker = L.marker(latlngs[latlngs.length - 1], {
        title: "Fin"
      }).addTo(map);

      drawnRoutes[route._id] = {
        polyline,
        startMarker,
        endMarker
      };

      map.fitBounds(polyline.getBounds());
    }

    function removeRoute(routeId) {
      const layers = drawnRoutes[routeId];
      if (!layers) return;

      map.removeLayer(layers.polyline);
      map.removeLayer(layers.startMarker);
      map.removeLayer(layers.endMarker);

      delete drawnRoutes[routeId];
    }

    function clearAll() {
      Object.keys(drawnRoutes).forEach(removeRoute);
      drawnRoutes.clear;
    }

    loadRoutes();
  </script>

</body>
</html>


